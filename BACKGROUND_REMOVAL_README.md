# Функция удаления фона для изображений товаров

## Описание

Добавлена функциональность удаления фона с изображений товаров с возможностью возврата к оригинальному изображению. Функция работает как при добавлении, так и при редактировании товаров.

## Установка зависимостей

Перед использованием функции удаления фона необходимо установить Python зависимости:

```bash
# Перейдите в корневую папку проекта
cd /path/to/bugu-store

# Запустите скрипт установки зависимостей
./scripts/install_dependencies.sh

# Или установите вручную
pip3 install -r requirements.txt
```

## Как это работает

### 1. Загрузка изображений
- При загрузке изображений они сохраняются в S3 как обычно
- Оригинальные URL сохраняются для возможности возврата

### 2. Удаление фона
- При нажатии на кнопку удаления фона (синяя кнопка с кисточкой) изображение отправляется на обработку
- Python скрипт `remove_background.py` обрабатывает изображение и удаляет фон
- Обработанное изображение сохраняется в S3 с суффиксом `_no_bg`
- В интерфейсе отображается обработанное изображение

### 3. Возврат к оригиналу
- При нажатии на оранжевую кнопку с стрелкой изображение возвращается к оригинальному виду
- Оригинальное изображение остается в S3

### 4. Сохранение товара
- При сохранении товара в S3 остаются только те изображения, которые видит пользователь в модальном окне
- Неиспользуемые изображения (оригинальные, если выбран обработанный вариант) удаляются из S3
- В базе данных сохраняются URL тех изображений, которые остались в S3

## Компоненты

### BackgroundRemoveButton
- Кнопка для удаления фона и возврата к оригиналу
- Показывает состояние обработки
- Отображает ошибки при неудачной обработке

### API Endpoints

#### POST /api/upload/remove-background
Удаляет фон с изображения и сохраняет результат в S3.

**Параметры:**
```json
{
  "imageUrl": "https://s3.example.com/bucket/products/image.jpg"
}
```

**Ответ:**
```json
{
  "success": true,
  "originalUrl": "https://s3.example.com/bucket/products/image.jpg",
  "processedUrl": "https://s3.example.com/bucket/products/image_no_bg.jpg",
  "message": "Фон успешно удален"
}
```

#### POST /api/upload/cleanup
Очищает неиспользуемые изображения из S3.

**Параметры:**
```json
{
  "urlsToKeep": ["https://s3.example.com/bucket/products/image1.jpg"],
  "urlsToDelete": ["https://s3.example.com/bucket/products/image2.jpg"]
}
```

## Использование

### В модальном окне добавления товара
1. Загрузите изображения как обычно
2. Наведите курсор на изображение
3. Нажмите синюю кнопку с кисточкой для удаления фона
4. Нажмите оранжевую кнопку со стрелкой для возврата к оригиналу
5. Сохраните товар

### В модальном окне редактирования товара
1. Откройте модальное окно управления изображениями
2. Используйте кнопки удаления фона для каждого изображения
3. Сохраните изменения

## Технические детали

- Используется библиотека `rembg` для удаления фона
- Обработанные изображения сохраняются с белым фоном
- Поддерживаются форматы: JPG, PNG, WebP
- Максимальный размер файла: 10MB
- Обработка происходит асинхронно с индикатором загрузки

## Устранение неполадок

### Ошибка "Python script error"
- Убедитесь, что Python3 установлен
- Проверьте, что установлены все зависимости: `pip3 install -r requirements.txt`
- Проверьте права доступа к скрипту: `chmod +x scripts/remove_background.py`

### Ошибка "Ошибка обработки изображения"
- Проверьте, что изображение корректно загружено в S3
- Убедитесь, что формат изображения поддерживается
- Проверьте размер файла (не более 10MB)

### Ошибка "Ошибка удаления фона"
- Проверьте подключение к S3
- Убедитесь, что у приложения есть права на запись в S3
- Проверьте логи сервера для подробной информации об ошибке
